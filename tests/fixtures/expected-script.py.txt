from argparse import ArgumentParser

import polars as pl
import opendp.prelude as dp
import matplotlib.pyplot as plt

# The OpenDP team is working to vet the core algorithms.
# Until that is complete we need to opt-in to use these features.
dp.enable_features("contrib")


def make_cut_points(lower_bound, upper_bound, bin_count):
    """
    Returns one more cut point than the bin_count.
    (There are actually two more bins, extending to
    -inf and +inf, but we'll ignore those.)
    Cut points are evenly spaced from lower_bound to upper_bound.
    """
    bin_width = (upper_bound - lower_bound) / bin_count
    return [round(lower_bound + i * bin_width, 2) for i in range(bin_count + 1)]


def df_to_columns(df):
    """
    >>> import polars as pl
    >>> df = pl.DataFrame({
    ...     "bin": ["A", "B", "C"],
    ...     "len": [0, 10, 20],
    ... })
    >>> _df_to_columns(df)
    (['A', 'B', 'C'], [0, 10, 20])
    """
    return tuple(list(df[col]) for col in df.columns)


def plot_histogram(histogram_df, error, cutoff):  # pragma: no cover
    bins, values = df_to_columns(histogram_df)
    mod = (len(bins) // 12) + 1
    majors = [label for i, label in enumerate(bins) if i % mod == 0]
    minors = [label for i, label in enumerate(bins) if i % mod != 0]
    _figure, axes = plt.subplots()
    bar_colors = ["blue" if v > cutoff else "lightblue" for v in values]
    axes.bar(bins, values, color=bar_colors, yerr=error)
    axes.set_xticks(majors, majors)
    axes.set_xticks(minors, ["" for _ in minors], minor=True)
    axes.axhline(cutoff, color="lightgrey", zorder=-1)
    axes.set_ylim(bottom=0)


# From the public information, determine the bins:
fake_column_cut_points = make_cut_points(
    lower_bound=5,
    upper_bound=15,
    bin_count=20,
)

# Use these bins to define a Polars column:
fake_column_config = (
    pl.col('fake column')
    .cut(fake_column_cut_points)
    .alias('fake_column_bin')  # Give the new column a name.
    .cast(pl.String)
)



def get_context(csv_path):
    privacy_unit = dp.unit_of(contributions=1)

    privacy_loss = dp.loss_of(epsilon=1, delta=1e-7)

    context = dp.Context.compositor(
        data=pl.scan_csv(csv_path, encoding="utf8-lossy"),
        privacy_unit=privacy_unit,
        privacy_loss=privacy_loss,
        split_by_weights=[4],
        margins={
       (): dp.polars.Margin(
            public_info="lengths",
        ),

        ("fake column_bin",): dp.polars.Margin(
            public_info="keys",
        ),
    },
    )

    return context


if __name__ == "__main__":
    parser = ArgumentParser(
        description="Creates a differentially private release from a csv"
    )
    parser.add_argument("--csv", help="Path to csv containing private data")
    args = parser.parse_args()
    context = get_context(csv_path=args.csv)

    confidence = 0.95

    fake column_query = context.query().group_by('fake column_bin').agg(pl.len().dp.noise())
    fake column_accuracy = fake column_query.summarize(alpha=1 - confidence)["accuracy"].item()
    fake column_histogram = fake column_query.release().collect().sort('fake column_bin')
    plot_histogram(fake column_histogram, fake column_accuracy, 0)
